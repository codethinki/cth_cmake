name: CI Pipeline

on:
  push:
    paths-ignore: ['**.md']
  pull_request:
    paths-ignore: ['**.md']
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  # --- Phase 1: Build Docker Environment ---
  prepare-env:
    uses: ./.github/workflows/build-image.yml
    secrets: inherit

  # --- Phase 2: Run Tests (Depends on Phase 1) ---
  run-tests:
    needs: prepare-env
    uses: ./.github/workflows/run-tests.yml
    with:
      image-tag: ${{ needs.prepare-env.outputs.image-tag }}
    secrets: inherit
